"""
Chinese Idiom (成语) service — curated list with random daily selection.
Uses a built-in list so no external API is needed.
"""

from __future__ import annotations

import datetime
import hashlib


# Curated idioms: (idiom, pinyin, meaning, story)
_IDIOMS: list[tuple[str, str, str, str]] = [
    (
        "画龙点睛",
        "huà lóng diǎn jīng",
        "比喻写文章或讲话时，在关键处用几句话点明实质，使内容更加生动有力。",
        "南朝梁画家张僧繇在安乐寺壁上画了四条龙，但都没有画眼睛。有人问他为什么，他说画上眼睛龙就会飞走。众人不信，他便为其中两条龙点上眼睛，果然雷电大作，二龙破壁飞去。",
    ),
    (
        "塞翁失马",
        "sài wēng shī mǎ",
        "比喻一时虽然受到损失，反而因此能得到好处。也指坏事在一定条件下可变为好事。",
        "塞上有个老翁丢了一匹马，邻居都来安慰他，他说这不一定是坏事。果然过了几天，那匹马带着一匹好马回来了。邻居来祝贺他，他又说这不一定是好事。后来他儿子骑那匹好马时摔断了腿，但因此免于被征去打仗。",
    ),
    (
        "卧薪尝胆",
        "wò xīn cháng dǎn",
        "形容人刻苦自励，发奋图强。",
        "春秋时期，越王勾践兵败被俘后在吴国受尽屈辱。回国后他睡在柴草上，每天尝一尝苦胆，时刻提醒自己不忘耻辱，发愤图强，最终灭掉了吴国。",
    ),
    (
        "如鱼得水",
        "rú yú dé shuǐ",
        "比喻得到跟自己很投合的人或对自己很合适的环境。",
        "刘备三顾茅庐请得诸葛亮出山后，对关羽和张飞说：「我得到孔明，就像鱼得到了水一样。」后来便用此比喻得到最理想的帮助或环境。",
    ),
    (
        "破釜沉舟",
        "pò fǔ chén zhōu",
        "比喻下决心不顾一切地干到底。",
        "秦末，项羽率兵渡漳河后，命令士兵把船凿沉，把锅砸破，每人只带三天的干粮，表示决一死战的决心。最终大破秦军。",
    ),
    (
        "班门弄斧",
        "bān mén nòng fǔ",
        "在行家面前卖弄本领，比喻自不量力。",
        "鲁班是古代著名的木匠。有人在鲁班门前摆弄斧头，比喻在行家面前卖弄本事，不自量力。",
    ),
    (
        "对牛弹琴",
        "duì niú tán qín",
        "比喻对不懂事理的人讲道理或说事，也比喻说话时不看对象。",
        "古代有个叫公明仪的人善弹琴，有一天对着一头正在吃草的牛弹了一首高雅的曲子，牛毫不理会，依旧低头吃草。",
    ),
    (
        "掩耳盗铃",
        "yǎn ěr dào líng",
        "比喻自己欺骗自己，明明掩盖不住的事情偏要想法子掩盖。",
        "春秋时，有人想偷范氏家的一口大钟，因为钟太大搬不走，想用锤子砸碎再带走。可是一砸钟就发出巨大的声响，于是他捂住自己的耳朵，以为自己听不到别人也就听不到了。",
    ),
    (
        "守株待兔",
        "shǒu zhū dài tù",
        "比喻不主动努力，而存万一的侥幸心理，希望得到意外的收获。",
        "宋国有个农夫，一天看到一只兔子撞在田边的树桩上摔死了。从此他便放下锄头，天天坐在树桩旁边等，希望再捡到撞死的兔子。可是再也没有兔子来撞树桩了，他的田地也荒废了。",
    ),
    (
        "叶公好龙",
        "yè gōng hào lóng",
        "比喻口头上说爱好某事物，实际上并不真爱好。",
        "叶公子高非常喜欢龙，家里到处雕刻着龙的图案。天上的真龙听说了，便飞到他家来见他。叶公一看到真龙，吓得魂飞魄散，转身就跑。可见他并不是真的喜欢龙。",
    ),
    (
        "愚公移山",
        "yú gōng yí shān",
        "比喻坚持不懈地改造自然和坚定不移地进行斗争。",
        "年近九十的愚公家门前有太行、王屋两座大山挡路，他决心率全家把山铲平。有人笑他痴愚，他说我死了有儿子，儿子死了有孙子，子子孙孙无穷尽，而山不会增高。天帝被其诚意感动，派天神把两座山搬走了。",
    ),
    (
        "望梅止渴",
        "wàng méi zhǐ kě",
        "比喻愿望无法实现，用空想安慰自己。",
        "曹操带兵行军，天气炎热，士兵们口渴难耐。曹操骗他们说前面有一大片梅林，又甜又酸。士兵们一听，嘴里自然生出了口水，暂时缓解了口渴。",
    ),
    (
        "刻舟求剑",
        "kè zhōu qiú jiàn",
        "比喻办事刻板，拘泥而不知变通。",
        "楚国有人坐船时把剑掉进了水里，他急忙在船舷上刻了个记号，说「我的剑就是从这里掉下去的」。等船停了，他从刻记号的地方下水找剑，当然找不到了。",
    ),
    (
        "纸上谈兵",
        "zhǐ shàng tán bīng",
        "比喻空谈理论，不能解决实际问题。",
        "战国时赵国名将赵奢之子赵括，少时熟读兵法，谈起用兵之道，连父亲也难不倒他。后来他代替廉颇为将，只知照搬兵书，不知灵活应变，结果在长平之战中惨败，赵军四十万被坑杀。",
    ),
]


def fetch_idiom() -> dict:
    """
    Pick a deterministic "idiom of the day" based on the current date.
    Returns a dict matching the ChineseIdiom proto message.
    """
    today = datetime.date.today().isoformat()
    # Deterministic but varied daily selection
    idx = int(hashlib.md5(today.encode()).hexdigest(), 16) % len(_IDIOMS)
    idiom, pinyin, meaning, story = _IDIOMS[idx]

    return {
        "idiom": idiom,
        "pinyin": pinyin,
        "meaning": meaning,
        "story": story,
    }
